version: '3.8'

# FunZone Infrastructure - Docker Compose for Development
# This file orchestrates all services from separated repositories for local development
# 
# Setup Instructions:
# 1. Clone all repositories as submodules or place them in the same parent directory
# 2. Update the build contexts below to match your repository structure
# 3. Copy env.example to .env and configure environment variables
# 4. Run: docker-compose -f docker-compose.dev.yml up --build

services:
  # PostgreSQL Database
  db:
    image: postgres:16-alpine
    container_name: funzone_postgres_dev
    environment:
      POSTGRES_DB: funzone_db
      POSTGRES_USER: funzone_user
      POSTGRES_PASSWORD: funzone_password
      POSTGRES_HOST_AUTH_METHOD: md5
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./data/FunZoneApp.backup:/docker-entrypoint-initdb.d/FunZoneApp.backup:ro
      - ./scripts/01-restore-backup.sh:/docker-entrypoint-initdb.d/01-restore-backup.sh:ro
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U funzone_user -d funzone_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for caching
  redis:
    image: redis:7-alpine
    container_name: funzone_redis_dev
    ports:
      - "6380:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MongoDB for logging
  mongodb:
    image: mongo:7.0
    container_name: funzone_mongodb_dev
    ports:
      - "27018:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_USER:-mongo_user}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASSWORD:-mongo_password}
      - MONGO_INITDB_DATABASE=logdb
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Django Backend (Development)
  # Build context should point to the funzone-backend repository
  backend:
    build:
      context: ../funzone-backend
      dockerfile: Dockerfile
    container_name: funzone_backend_dev
    ports:
      - "8888:8000"
    environment:
      - DEBUG=True
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key}
      - DATABASE_URL=postgresql://funzone_user:funzone_password@db:5432/funzone_db
      - REDIS_URL=redis://redis:6379/0
      - ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0,backend
      - DJANGO_SETTINGS_MODULE=funzone.settings
      - POSTGRES_USER=funzone_user
      - POSTGRES_PASSWORD=funzone_password
      - POSTGRES_DB=funzone_db
      - DB_HOST=db
      - MONGO_HOST=mongodb
      - MONGO_PORT=27017
      - MONGO_LOG_DB=logdb
      - MONGO_USER=${MONGO_USER:-mongo_user}
      - MONGO_PASSWORD=${MONGO_PASSWORD:-mongo_password}
      - CORS_ALLOWED_ORIGINS=http://localhost:3002,http://localhost:3003,http://127.0.0.1:3002,http://127.0.0.1:3003
    volumes:
      - ../funzone-backend:/app
      - backend_media:/app/media
      - backend_logs:/app/logs
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    restart: unless-stopped
    entrypoint: ["/bin/sh", "-c"]
    command: "python wait-for-db.py && python manage.py migrate --noinput && python add_categories.py || echo 'Warning: Failed to initialize categories' && python manage.py runserver 0.0.0.0:8000"

  # React Customer App (Development)
  # Build context should point to the funzone-frontend-customer repository
  frontend-customer:
    build:
      context: ../funzone-frontend-customer
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE_URL=${VITE_API_BASE_URL:-http://localhost:8888/api}
    container_name: funzone_frontend_customer_dev
    ports:
      - "3002:80"
    volumes:
      - ../funzone-frontend-customer:/app
      - /app/node_modules
    depends_on:
      - backend
    restart: unless-stopped

  # React Owner App (Development)
  # Build context should point to the funzone-frontend-owner repository
  frontend-owner:
    build:
      context: ../funzone-frontend-owner
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE_URL=${VITE_API_BASE_URL:-http://localhost:8888/api}
    container_name: funzone_frontend_owner_dev
    ports:
      - "3003:80"
    volumes:
      - ../funzone-frontend-owner:/app
      - /app/node_modules
    depends_on:
      - backend
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  mongodb_data:
  mongodb_config:
  backend_media:
  backend_logs:

